<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi-Bot | Alumbrado P√∫blico</title>
    
    <link rel="icon" type="image/png" href="Aguascalientes.png"> 
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- ESTILOS CSS --- */
        
        /* === FONDO EXTERIOR (BODY) === */
        body {
            font-family: Arial, sans-serif;
            background-image: url('Fondo animado.avif'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
        }

        /* === PANTALLA DE CARGA (SPLASH SCREEN) === */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #128c7e; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            animation: bounce 1s infinite alternate;
        }
        
        #splash-screen h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 5px;
        }

        #splash-screen p {
            color: #dcf8c6;
            font-size: 1em;
        }

        @keyframes bounce {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }
        
        /* === CONTENEDOR DEL CHAT (CHAT CONTAINER) === */
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 80vh;
            max-height: 700px;
            background-color: #f7f7f7; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
            opacity: 0; 
            transition: opacity 0.5s ease-in;
        }

        /* === ESTILOS DEL CHAT (RESTO) === */
        .chat-header {
            background-color: #128c7e;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-avatar {
            background-color: #f0f0f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            overflow: hidden;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .header-info p {
            margin: 0;
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* üé® RESTAURACI√ìN DE FONDO DE CHAT CON MAYOR OPACIDAD DE FONDO BASE */
        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            /* TU IMAGEN DE FONDO */
            background-image: url('Luminarias aguascalientes.jpeg'); 
            background-size: cover; 
            background-position: center; 
            background-color: rgba(229, 221, 213, 0.7); /* Color base claro con 70% de opacidad para la imagen de fondo */
            background-blend-mode: color; /* Mezcla el color base con la imagen para aclararla */
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .bot-message {
            background-color: #ffffff; 
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .user-message {
            background-color: #dcf8c6; 
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .message-time {
            display: block;
            font-size: 0.65em;
            color: #777;
            text-align: right;
            margin-top: 5px;
            line-height: 1;
        }
        
        .message-image-container {
            max-width: 100%;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .chat-footer {
            padding: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px 15px;
            border-radius: 20px;
            font-size: 1em;
            margin: 0 8px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .chat-footer button {
            background-color: #128c7e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 4px;
            transition: background-color 0.3s;
        }

        .chat-footer button:hover {
            background-color: #0e6c60;
        }

        #attach-button {
            background-color: transparent;
            color: #777;
            width: 44px;
            height: 44px;
            margin-left: 4px;
        }
        
        #attach-button:hover {
            color: #555;
            background-color: transparent;
        }

        #attach-button .material-icons {
            transform: rotate(45deg); 
        }

        #report-button {
            position: absolute;
            top: 15px; 
            right: 15px; 
            background-color: #dc3545; 
            color: white;
            border: none;
            border-radius: 8px; 
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
            z-index: 10; 
        }

        #report-button:hover {
            background-color: #c82333; 
        }

        #report-button .material-icons {
            font-size: 24px; 
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="Logo alumbrado publico cute.jpg" alt="Logo Lumi-Bot">
        <h1>Lumi-Bot</h1>
        <p>Iniciando servicio de alumbrado...</p>
    </div>

    <div class="chat-container" id="chat-container">
        
        <button id="report-button" onclick="startQuickReport()">
            <span class="material-icons">lightbulb_outline</span> 
        </button>

        <div class="chat-header">
            <div class="header-avatar">
                <img src="Logo alumbrado publico cute.jpg" alt="Lumi-Bot Logo">
            </div>
            <div class="header-info">
                <h3>Lumi-Bot</h3>
                <p>Alumbrado P√∫blico | La voz de la luz</p>
            </div>
        </div>

        <div class="chat-body" id="chat-body">
        </div>

        <div class="chat-footer">
            <button id="attach-button" onclick="document.getElementById('file-input').click();">
                <span class="material-icons">attach_file</span>
            </button>

            <input type="file" id="file-input" accept="image/*" style="display: none;">

            <input type="text" id="user-input" placeholder="Escribe..." onkeypress="handleKeyPress(event)">

            <button onclick="sendMessage()">
                <span class="material-icons">send</span>
            </button>
        </div>
    </div>

    <script>
        // --- L√ìGICA JAVASCRIPT ---
        const chatContainer = document.getElementById('chat-container');
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const splashScreen = document.getElementById('splash-screen');
        // Clave de almacenamiento local, ya no se usa para el folio, solo para la conversaci√≥n
        const CHAT_STORAGE_KEY = 'lumi-bot-conversation';
        
        const DEFAULT_RESPONSE = "Lo siento, esa pregunta es nueva para m√≠. Intenta con **'hola'**, **'reportar'** o **'horario'** para guiarte.";

        // Estado: Almacena temporalmente la ubicaci√≥n para el reporte
        let currentReportLocation = null;
        
        // Estado: Indica si el bot est√° esperando el folio o la direcci√≥n del usuario
        let waitingForFolio = false;

        const DETAILED_STATUS_MESSAGE = "Estamos d√°ndole seguimiento a todas las solicitudes. Actualmente, tu reporte se encuentra en estado de **Verificaci√≥n en Campo** o **Reparaci√≥n Activa**.\n\nRecuerda que si ves una 'X' con cinta negra en la base, significa que fue **diagnosticada** y est√° en la lista de reparaciones prioritarias. ¬°El tiempo de atenci√≥n es de 24 a 72 horas h√°biles!";

        // --- OBJETO DE RESPUESTAS PERSONALIZADAS ---
        const RESPUESTAS = {
             "hola": {
                "variantes": ["hola", "holaaaa", "olis", "oli", "ola", "wenas", "buenos d√≠as", "buenas tardes"],
                "respuesta": "¬°Hola! Soy **Lumi-Bot**, tu asistente para Alumbrado P√∫blico. ¬øEn qu√© puedo ayudarte hoy?"
            },
            "qui√©n eres": {
                "variantes": ["qui√©n eres", "quien eres", "qu√© eres", "que eres"],
                "respuesta": "Soy un Chat-Bot dise√±ado para darte informaci√≥n y ayudarte a gestionar reportes del √°rea de Alumbrado P√∫blico. **¬°Mi misi√≥n es que tu calle brille!**"
            },
            "qu√© haces": {
                "variantes": ["qu√© haces", "que haces", "a qu√© te dedicas"],
                "respuesta": "Puedo responder dudas sobre reportes, servicios y horarios. Si quieres reportar una falla puedes escribir **'Reportar'** o si quieres saber del estado de tu reporte escribe **'Seguimiento'**."
            },
            "reportar": {
                "variantes": ["c√≥mo reporto una falla", "como reporto una falla", "quiero reportar una falla", "reportar", "reporte rapido"],
                "respuesta": "¬°Entendido! Vamos a generar un **Reporte R√°pido**. Primero, necesito tu ubicaci√≥n. El sistema ha solicitado permiso para usar tu GPS. Por favor, **acepta la solicitud de ubicaci√≥n** que aparece en tu navegador.\n\nSi ya lo hiciste, por favor, env√≠a un mensaje con la **Direcci√≥n exacta Y LA DESCRIPCI√ìN DE LA FALLA SEPARADA POR UNA COMA** (ej: calle X, luminaria parpadea). Puedes adjuntar una **foto** (opcional)."
            },
            "horario": {
                "variantes": ["cu√°l es tu horario", "cual es tu horario", "horario de atenci√≥n", "horario", "cual es el horario de alumbrado publico", "cual es el horario"],
                "respuesta": "El horario de atenci√≥n de Alumbardo Publico es de **Lunes a Domingo** y circulamos las **24 horas**."
            },
            "estado de reporte": {
                "variantes": ["reportes", "quiero saber de mi reporte", "seguimiento", "estado de mi reporte"],
                "respuesta": "INICIAR SEGUIMIENTO: <br>Perfecto, voy a buscar tu reporte. Por favor, ind√≠came tu **n√∫mero de folio** o la **direcci√≥n exacta** que reportaste."
            },
            "gracias": { "variantes": ["gracias", "muchas gracias"], "respuesta": "¬°De nada! Es un placer iluminar tu camino. " },
            "numero": { "variantes": ["numero", "cual es el numero"], "respuesta": "El n√∫mero oficial para reportes es el **072**. ¬°Gu√°rdalo! O si tienes problemas puedes llamar tambi√©n a este n√∫mero **449 910 1019**." },
            
            "link": {
                "variantes": ["link", "enlace", "formulario", "pagina web", "reporte detallado"],
                "respuesta": "Si quieres hacer un reporte m√°s detallado entra al siguiente enlace: \n** https://jonemoto24.github.io/Alumbrado-publico-de-Aguascalientes/ **\nEste link te facilitar√° m√°s la gesti√≥n de reportes."
            },
            "lamparas nuevas": {
                "variantes": ["lamparas nuevas", "nuevas lamparas", "instalacion", "cambio de luz"],
                "respuesta": "Constantemente estamos actualizando la infraestructura. Para solicitar la **instalaci√≥n de nuevas luminarias** o un **cambio de tecnolog√≠a**, es necesario comunicarte al **072** para evaluar la viabilidad del proyecto en tu zona."
            },
            "significado de alumbrado publico": {
                "variantes": ["significado de alumbrado publico", "que es alumbrado publico", "que significa alumbrado", "definicion"],
                "respuesta": "El **Alumbrado P√∫blico** es el servicio que busca iluminar las v√≠as de circulaci√≥n y los espacios p√∫blicos. Su prop√≥sito es proporcionar **seguridad**, **visibilidad** y **mejorar la calidad de vida** de los ciudadanos durante la noche."
            },
            "lampara caida": {
                "variantes": ["lampara caida", "poste caido", "luminaria tirada", "columna rota", "peligro"],
                "respuesta": "üö® **¬°ATENCI√ìN, PELIGRO!** Si una l√°mpara, poste o luminaria est√° ca√≠da, representa un riesgo el√©ctrico y f√≠sico. Por favor, llama inmediatamente al n√∫mero de **Emergencias (911)** y notifica tambi√©n al **072** para que sea atendida con m√°xima prioridad."
            },
            "fotoceldas": {
                "variantes": ["fotoceldas", "foto celda", "porque se prende de dia", "se prende de dia"],
                "respuesta": "Las luminarias son controladas por **fotoceldas**, que son sensores de luz. Si una l√°mpara enciende de d√≠a, la fotocelda probablemente est√° fallando. Este es un reporte com√∫n; por favor, usa **'Reportar'** para indicarnos la direcci√≥n y corregir el problema."
            },
            "colores de las lamparas": {
                "variantes": ["colores de las lamparas", "luz amarilla", "luz blanca", "tipo de lampara"],
                "respuesta": "En Aguascalientes usamos principalmente tecnolog√≠a **LED (luz blanca/fr√≠a)** por su eficiencia energ√©tica. Anteriormente se usaba **Vapor de Sodio (luz amarilla)**. Si detectas un cambio de color abrupto o intermitente, podr√≠a ser se√±al de una falla que requiere reparaci√≥n."
            }
        };

        // --- FUNCIONES DE UTILIDAD ---
        
        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function saveConversation() {
            // Guarda la conversaci√≥n (actualmente desactivado)
        }
        
        function appendMessage(text, sender, imageURL = null) {
            const time = getCurrentTime();
            const messageDiv = document.createElement('div');
            // Reemplaza \n (saltos de l√≠nea) por <br> y da formato a negritas
            const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.classList.add('message-bubble', sender === 'bot' ? 'bot-message' : 'user-message');

            let contentHTML = '';

            if (imageURL) {
                contentHTML += `
                    <div class="message-image-container">
                        <img src="${imageURL}" alt="Imagen adjunta" class="message-image">
                    </div>
                `;
            }

            contentHTML += `<span>${formattedText}</span>`;
            contentHTML += `<span class="message-time">${time}</span>`;

            messageDiv.innerHTML = contentHTML;
            chatBody.appendChild(messageDiv);

            chatBody.scrollTop = chatBody.scrollHeight;
            saveConversation();
        }

        function getBotResponse(userText) {
            const lowerCaseText = userText.toLowerCase().trim();

            if (waitingForFolio) {
                if (lowerCaseText.length > 2) { 
                    waitingForFolio = false; 
                    return DETAILED_STATUS_MESSAGE; 
                }
            }
            
            for (const key in RESPUESTAS) {
                const item = RESPUESTAS[key];
                for (const variant of item.variantes) {
                    if (lowerCaseText.includes(variant.toLowerCase())) {
                        if (key === "estado de reporte") {
                            waitingForFolio = true;
                        }
                        return item.respuesta;
                    }
                }
            }
            return DEFAULT_RESPONSE;
        }

        function processUserMessage(userText) {
            const botResponse = getBotResponse(userText);
            
            if (botResponse.startsWith("INICIAR SEGUIMIENTO:")) {
                const displayResponse = botResponse.substring("INICIAR SEGUIMIENTO:".length).trim();
                setTimeout(() => {
                    appendMessage(displayResponse, 'bot');
                }, 800);
            } else {
                setTimeout(() => {
                    appendMessage(botResponse, 'bot');
                }, 800);
            }
        }
        
        // =========================================================================================
        // üíæ FUNCI√ìN DE ENV√çO DE REPORTE A API DE VERCEL
        // El servidor asigna y devuelve el folio √∫nico.
        // =========================================================================================

        const API_URL = 'https://lavozdelaluz-lumibot.vercel.app/api/report'; 

        function sendReportToBackend(reportData) {
            console.log("Enviando reporte al servidor para asignaci√≥n de folio √∫nico:", reportData);
            
            appendMessage(`‚åõ Procesando reporte... Guardando datos y asignando **Folio √önico** en el sistema central.`, 'bot');

            fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(reportData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ‚úÖ CLAVE: El servidor debe devolver el folio generado (data.folio)
                if (data.success && data.folio) { 
                    const reportSummary = `
                        **‚úÖ REPORTE GENERADO CON √âXITO**
                        **Folio:** ${data.folio}
                        **Direcci√≥n:** ${reportData.direccion}
                        **Falla de la Luminaria:** ${reportData.descripcion_falla} ¬† ¬† ¬† ¬†
                        Tu reporte ha sido registrado. Conserva el **Folio ${data.folio}** para dar seguimiento.
                    `;
                    appendMessage(reportSummary, 'bot');
                } else {
                    // Si el servidor responde pero indica fallo interno 
                    appendMessage(`‚ö†Ô∏è **Fallo en el Sistema de Registro:** El servidor no pudo asignar el folio. Intenta m√°s tarde o llama al 072.`, 'bot');
                }
            })
            .catch(error => {
                console.error('Error de fetch o de la API:', error);
                appendMessage(`‚ùå **Error de red o del servidor:** No se pudo contactar al sistema central. Llama al 072.`, 'bot');
            });
        }

        // --- L√ìGICA DE ENV√çO Y REPORTE ---

        function sendMessage() {
            const userText = userInput.value.trim();
            const file = fileInput.files[0];
            let imageURL = null;

            if (!userText && !file) {
                return;
            }

            if (file) {
                imageURL = URL.createObjectURL(file);
            }

            const messageToSend = userText || '[Imagen de Reporte Adjunta]';
            appendMessage(messageToSend, 'user', imageURL);

            if (userText || file) {
                const textToProcess = userText || "quiero reportar una falla";

                if (currentReportLocation !== undefined && currentReportLocation !== null) {
                    
                    // ‚ùå EL FOLIO YA NO SE CALCULA AQU√ç
                    const textoCompleto = userText.trim();
                    let direccion = textoCompleto;
                    let descripcionFalla = "Falla sin describir o el texto no sigui√≥ el formato: Direcci√≥n, Falla.";
                    
                    const firstCommaIndex = textoCompleto.indexOf(',');

                    if (firstCommaIndex !== -1) {
                        direccion = textoCompleto.substring(0, firstCommaIndex).trim();
                        descripcionFalla = textoCompleto.substring(firstCommaIndex + 1).trim();
                    } 

                    const gpsString = currentReportLocation.latitude ? 
                        `${currentReportLocation.latitude.toFixed(6)}, ${currentReportLocation.longitude.toFixed(6)}` : 'No obtenida / Permiso rechazado';

                    const reportData = {
                        // ‚ùå EL CAMPO 'folio' YA NO SE ENV√çA. EL SERVIDOR LO ASIGNAR√Å.
                        fecha: new Date().toLocaleString(),
                        direccion: direccion,
                        descripcion_falla: descripcionFalla,
                        ubicacionGPS: gpsString,
                        imagenURL: file ? `Adjunta (${file.name})` : 'No',
                        estado: 'Reportado'
                    };

                    sendReportToBackend(reportData); 

                    currentReportLocation = undefined;
                    fileInput.value = ''; 

                } else {
                    processUserMessage(textToProcess);
                }
            }

            userInput.value = '';
            fileInput.value = '';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }
        
        // --- L√ìGICA DE GEOLOCALIZACI√ìN Y REPORTE R√ÅPIDO ---
        
        function requestLocation() {
            currentReportLocation = null; 
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentReportLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        // Enlace corregido para Google Maps
                        const mapLink = `http://maps.google.com/?q=${currentReportLocation.latitude},${currentReportLocation.longitude}`;
                        
                        appendMessage(`‚úÖ **Ubicaci√≥n GPS Obtenida:** Lat: ${currentReportLocation.latitude.toFixed(5)}, Long: ${currentReportLocation.longitude.toFixed(5)}.<br>([Ver en Mapa](${mapLink}))`, 'bot');
                        
                        appendMessage(`Ahora, por favor, escribe la **direcci√≥n exacta SEGUIDA DE UNA COMA y la falla** (ej: **Calle 5, la luminaria est√° apagada**).`, 'bot');
                        
                    },
                    (error) => {
                        let errorMessage = 'No fue posible obtener tu ubicaci√≥n GPS.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += '<br>Necesitas aceptar el permiso de ubicaci√≥n.';
                        } else {
                            errorMessage += `<br>Error: ${error.message}`;
                        }
                        appendMessage(`‚ö†Ô∏è **Alerta:** ${errorMessage}<br>Por favor, proporciona la direcci√≥n exacta y la descripci√≥n de la falla manualmente, usando el formato **Direcci√≥n, Falla** para continuar.`, 'bot');
                        currentReportLocation = { latitude: null, longitude: null }; 
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                appendMessage("‚ö†Ô∏è **Error:** Tu navegador no soporta la geolocalizaci√≥n. Por favor, proporciona la direcci√≥n exacta y la descripci√≥n de la falla manualmente, usando el formato **Direcci√≥n, Falla**.", 'bot');
                currentReportLocation = { latitude: null, longitude: null };
            }
        }

        function startQuickReport() {
             const reportMessage = RESPUESTAS["reportar"].respuesta;
             appendMessage(reportMessage, 'bot');
             requestLocation();
        }

        function sendBotInitialMessage() {
            const welcomeMessage = RESPUESTAS["hola"].respuesta + 
                "<br><br>¬øTe gustar√≠a hacer un **Reporte R√°pido**? Puedes usar el bot√≥n rojo üí° de arriba, o escribir **'Reportar'** o ¬øTienes una pregunta sobre **Horarios** o **Seguimiento**?";
            appendMessage(welcomeMessage, 'bot');
        }
        
        function loadConversation() {
            // Limpia la conversaci√≥n anterior (si existiera)
            localStorage.removeItem(CHAT_STORAGE_KEY);
            chatBody.innerHTML = ''; 
        }

        function initializeApp() {
            loadConversation(); 
            const splashDuration = 2000; 

            setTimeout(() => {
                splashScreen.style.opacity = '0';
                chatContainer.style.opacity = '1';
                
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    sendBotInitialMessage();
                }, 500);
                
            }, splashDuration);
        }
        
        window.onload = initializeApp;

    </script>
</body>
</html>

