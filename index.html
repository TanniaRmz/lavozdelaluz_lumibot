<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi-Bot | Alumbrado PÃºblico</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- ESTILOS CSS --- */
        
        /* === FONDO EXTERIOR (BODY) === */
        body {
            font-family: Arial, sans-serif;
            /* AsegÃºrate de que este archivo 'Fondo animado.avif' exista en tu repositorio */
            background-image: url('Fondo animado.avif'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
        }

        /* === PANTALLA DE CARGA (SPLASH SCREEN) === */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #128c7e; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            animation: bounce 1s infinite alternate;
        }
        
        #splash-screen h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 5px;
        }

        #splash-screen p {
            color: #dcf8c6;
            font-size: 1em;
        }

        @keyframes bounce {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }
        
        /* === CONTENEDOR DEL CHAT (CHAT CONTAINER) === */
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 80vh;
            max-height: 700px;
            background-color: #f7f7f7; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
            opacity: 0; 
            transition: opacity 0.5s ease-in;
        }

        /* === ESTILOS DEL CHAT (RESTO) === */
        .chat-header {
            background-color: #128c7e;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-avatar {
            background-color: #f0f0f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            overflow: hidden;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .header-info p {
            margin: 0;
            font-size: 0.8em;
            opacity: 0.8;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            /* AsegÃºrate de que este archivo 'Luminarias aguascalientes.jpeg' exista en tu repositorio */
            background-image: url('Luminarias aguascalientes.jpeg'); 
            background-size: cover; 
            background-position: center; 
            background-color: #e5ddd5; 
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }

        .bot-message {
            background-color: #ffffff; 
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .user-message {
            background-color: #dcf8c6; 
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .message-time {
            display: block;
            font-size: 0.65em;
            color: #777;
            text-align: right;
            margin-top: 5px;
            line-height: 1;
        }
        
        .message-image-container {
            max-width: 100%;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .chat-footer {
            padding: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px 15px;
            border-radius: 20px;
            font-size: 1em;
            margin: 0 8px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .chat-footer button {
            background-color: #128c7e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 4px;
            transition: background-color 0.3s;
        }

        .chat-footer button:hover {
            background-color: #0e6c60;
        }

        #attach-button {
            background-color: transparent;
            color: #777;
            width: 44px;
            height: 44px;
            margin-left: 4px;
        }
        
        #attach-button:hover {
            color: #555;
            background-color: transparent;
        }

        #attach-button .material-icons {
            transform: rotate(45deg); 
        }

        #report-button {
            position: absolute;
            top: 15px; 
            right: 15px; 
            background-color: #dc3545; 
            color: white;
            border: none;
            border-radius: 8px; 
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
            z-index: 10; 
        }

        #report-button:hover {
            background-color: #c82333; 
        }

        #report-button .material-icons {
            font-size: 24px; 
        }
    </style>
</head>
<body>

Â  Â  <div id="splash-screen">
Â  Â  Â  Â  <img src="Logo alumbrado publico cute.jpg" alt="Logo Lumi-Bot">
Â  Â  Â  Â  <h1>Lumi-Bot</h1>
Â  Â  Â  Â  <p>Iniciando servicio de alumbrado...</p>
Â  Â  </div>

Â  Â  <div class="chat-container" id="chat-container">
Â  Â  Â  Â  
Â  Â  Â  Â  <button id="report-button" onclick="startQuickReport()">
Â  Â  Â  Â  Â  Â  <span class="material-icons">lightbulb_outline</span> 
Â  Â  Â  Â  </button>

Â  Â  Â  Â  <div class="chat-header">
Â  Â  Â  Â  Â  Â  <div class="header-avatar">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="Logo alumbrado publico cute.jpg" alt="Lumi-Bot Logo">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="header-info">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Lumi-Bot</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Alumbrado PÃºblico | La voz de la luz</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chat-body" id="chat-body">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chat-footer">
Â  Â  Â  Â  Â  Â  <button id="attach-button" onclick="document.getElementById('file-input').click();">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="material-icons">attach_file</span>
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <input type="file" id="file-input" accept="image/*" style="display: none;">

Â  Â  Â  Â  Â  Â  <input type="text" id="user-input" placeholder="Escribe..." onkeypress="handleKeyPress(event)">

Â  Â  Â  Â  Â  Â  <button onclick="sendMessage()">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="material-icons">send</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- LÃ“GICA JAVASCRIPT ---
Â  Â  Â  Â  const chatContainer = document.getElementById('chat-container');
Â  Â  Â  Â  const chatBody = document.getElementById('chat-body');
Â  Â  Â  Â  const userInput = document.getElementById('user-input');
Â  Â  Â  Â  const fileInput = document.getElementById('file-input');
Â  Â  Â  Â  const splashScreen = document.getElementById('splash-screen');
Â  Â  Â  Â  // Claves de almacenamiento local
Â  Â  Â  Â  const CHAT_STORAGE_KEY = 'lumi-bot-conversation';
Â  Â  Â  Â  const FOLIO_COUNTER_KEY = 'lumi-bot-folio-counter';
Â  Â  Â  Â  
Â  Â  Â  Â  const DEFAULT_RESPONSE = "Lo siento, esa pregunta es nueva para mÃ­. Intenta con **'hola'**, **'reportar'** o **'horario'** para guiarte.";

Â  Â  Â  Â  // Estado: Almacena temporalmente la ubicaciÃ³n para el reporte
Â  Â  Â  Â  let currentReportLocation = null;
Â  Â  Â  Â  
Â  Â  Â  Â  // Estado: Indica si el bot estÃ¡ esperando el folio o la direcciÃ³n del usuario
Â  Â  Â  Â  let waitingForFolio = false;

Â  Â  Â  Â  const DETAILED_STATUS_MESSAGE = "Estamos dÃ¡ndole seguimiento a todas las solicitudes. Actualmente, tu reporte se encuentra en estado de **VerificaciÃ³n en Campo** o **ReparaciÃ³n Activa**.\n\nRecuerda que si ves una 'X' con cinta negra en la base, significa que fue **diagnosticada** y estÃ¡ en la lista de reparaciones prioritarias. Â¡El tiempo de atenciÃ³n es de 24 a 72 horas hÃ¡biles!";

Â  Â  Â  Â  // --- OBJETO DE RESPUESTAS PERSONALIZADAS ACTUALIZADO ---
Â  Â  Â  Â  const RESPUESTAS = {
Â  Â  Â  Â  Â  Â  "hola": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["hola", "holaaaa", "olis", "oli", "ola", "wenas", "buenos dÃ­as", "buenas tardes"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Â¡Hola! Soy **Lumi-Bot**, tu asistente para Alumbrado PÃºblico. Â¿En quÃ© puedo ayudarte hoy?"
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "quiÃ©n eres": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["quiÃ©n eres", "quien eres", "quÃ© eres", "que eres"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Soy un Chat-Bot diseÃ±ado para darte informaciÃ³n y ayudarte a gestionar reportes del Ã¡rea de Alumbrado PÃºblico. **Â¡Mi misiÃ³n es que tu calle brille!**"
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "quÃ© haces": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["quÃ© haces", "que haces", "a quÃ© te dedicas"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Puedo responder dudas sobre reportes, servicios y horarios. Si quieres reportar una falla puedes escribir **'Reportar'** o si quieres saber del estado de tu reporte escribe **'Seguimiento'**."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "reportar": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["cÃ³mo reporto una falla", "como reporto una falla", "quiero reportar una falla", "reportar", "reporte rapido"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Â¡Entendido! Vamos a generar un **Reporte RÃ¡pido**. Primero, necesito tu ubicaciÃ³n. El sistema ha solicitado permiso para usar tu GPS. Por favor, **acepta la solicitud de ubicaciÃ³n** que aparece en tu navegador.\n\nSi ya lo hiciste, por favor, envÃ­a un mensaje con la **DirecciÃ³n exacta Y LA DESCRIPCIÃ“N DE LA FALLA SEPARADA POR UNA COMA** (ej: calle X, luminaria parpadea). Puedes adjuntar una **foto** (opcional)."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "horario": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["cuÃ¡l es tu horario", "cual es tu horario", "horario de atenciÃ³n", "horario", "cual es el horario de alumbrado publico", "cual es el horario"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "El horario de atenciÃ³n de Alumbardo Publico es de **Lunes a Domingo** y circulamos las **24 horas**."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "estado de reporte": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["reportes", "quiero saber de mi reporte", "seguimiento", "estado de mi reporte"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "INICIAR SEGUIMIENTO: <br>Perfecto, voy a buscar tu reporte. Por favor, indÃ­came tu **nÃºmero de folio** o la **direcciÃ³n exacta** que reportaste."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "gracias": { "variantes": ["gracias", "muchas gracias"], "respuesta": "Â¡De nada! Es un placer iluminar tu camino. " },
Â  Â  Â  Â  Â  Â  "numero": { "variantes": ["numero", "cual es el numero"], "respuesta": "El nÃºmero oficial para reportes es el **072**. Â¡GuÃ¡rdalo! O si tienes problemas puedes llamar tambiÃ©n a este nÃºmero **449 910 1019**." },
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  "link": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["link", "enlace", "formulario", "pagina web", "reporte detallado"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Si quieres hacer un reporte mÃ¡s detallado entra al siguiente enlace: \n** https://jonemoto24.github.io/Alumbrado-publico-de-Aguascalientes/ **\nEste link te facilitarÃ¡ mÃ¡s la gestiÃ³n de reportes."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "lamparas nuevas": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["lamparas nuevas", "nuevas lamparas", "instalacion", "cambio de luz"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Constantemente estamos actualizando la infraestructura. Para solicitar la **instalaciÃ³n de nuevas luminarias** o un **cambio de tecnologÃ­a**, es necesario comunicarte al **072** para evaluar la viabilidad del proyecto en tu zona."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "significado de alumbrado publico": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["significado de alumbrado publico", "que es alumbrado publico", "que significa alumbrado", "definicion"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "El **Alumbrado PÃºblico** es el servicio que busca iluminar las vÃ­as de circulaciÃ³n y los espacios pÃºblicos. Su propÃ³sito es proporcionar **seguridad**, **visibilidad** y **mejorar la calidad de vida** de los ciudadanos durante la noche."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "lampara caida": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["lampara caida", "poste caido", "luminaria tirada", "columna rota", "peligro"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "ğŸš¨ **Â¡ATENCIÃ“N, PELIGRO!** Si una lÃ¡mpara, poste o luminaria estÃ¡ caÃ­da, representa un riesgo elÃ©ctrico y fÃ­sico. Por favor, llama inmediatamente al nÃºmero de **Emergencias (911)** y notifica tambiÃ©n al **072** para que sea atendida con mÃ¡xima prioridad."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "fotoceldas": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["fotoceldas", "foto celda", "porque se prende de dia", "se prende de dia"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "Las luminarias son controladas por **fotoceldas**, que son sensores de luz. Si una lÃ¡mpara enciende de dÃ­a, la fotocelda probablemente estÃ¡ fallando. Este es un reporte comÃºn; por favor, usa **'Reportar'** para indicarnos la direcciÃ³n y corregir el problema."
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  "colores de las lamparas": {
Â  Â  Â  Â  Â  Â  Â  Â  "variantes": ["colores de las lamparas", "luz amarilla", "luz blanca", "tipo de lampara"],
Â  Â  Â  Â  Â  Â  Â  Â  "respuesta": "En Aguascalientes usamos principalmente tecnologÃ­a **LED (luz blanca/frÃ­a)** por su eficiencia energÃ©tica. Anteriormente se usaba **Vapor de Sodio (luz amarilla)**. Si detectas un cambio de color abrupto o intermitente, podrÃ­a ser seÃ±al de una falla que requiere reparaciÃ³n."
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FUNCIONES DE UTILIDAD ---
Â  Â  Â  Â  
Â  Â  Â  Â  function getCurrentTime() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const hours = String(now.getHours()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const minutes = String(now.getMinutes()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  return `${hours}:${minutes}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveConversation() {
Â  Â  Â  Â  Â  Â  // Guarda el HTML del chat (comentado para reiniciar siempre la conversaciÃ³n)
Â  Â  Â  Â  Â  Â  // if (chatContainer.style.opacity === '1') {
Â  Â  Â  Â  Â  Â  // Â  Â  localStorage.setItem(CHAT_STORAGE_KEY, chatBody.innerHTML);
Â  Â  Â  Â  Â  Â  // }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function getNextFolio() {
Â  Â  Â  Â  Â  Â  let folio = parseInt(localStorage.getItem(FOLIO_COUNTER_KEY) || '0', 10);
Â  Â  Â  Â  Â  Â  folio++;
Â  Â  Â  Â  Â  Â  localStorage.setItem(FOLIO_COUNTER_KEY, folio.toString());
Â  Â  Â  Â  Â  Â  // Formato F-001
Â  Â  Â  Â  Â  Â  return `F-${String(folio).padStart(3, '0')}`; 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNCIÃ“N PRINCIPAL DE MENSAJES ---

Â  Â  Â  Â  function appendMessage(text, sender, imageURL = null) {
Â  Â  Â  Â  Â  Â  const time = getCurrentTime();
Â  Â  Â  Â  Â  Â  const messageDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  // Reemplaza \n (saltos de lÃ­nea) por <br> y da formato a negritas
Â  Â  Â  Â  Â  Â  const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
Â  Â  Â  Â  Â  Â  messageDiv.classList.add('message-bubble', sender === 'bot' ? 'bot-message' : 'user-message');

Â  Â  Â  Â  Â  Â  let contentHTML = '';

Â  Â  Â  Â  Â  Â  if (imageURL) {
Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-image-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${imageURL}" alt="Imagen adjunta" class="message-image">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  contentHTML += `<span>${formattedText}</span>`;
Â  Â  Â  Â  Â  Â  contentHTML += `<span class="message-time">${time}</span>`;

Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = contentHTML;
Â  Â  Â  Â  Â  Â  chatBody.appendChild(messageDiv);

Â  Â  Â  Â  Â  Â  chatBody.scrollTop = chatBody.scrollHeight;
Â  Â  Â  Â  Â  Â  saveConversation();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- LÃ“GICA DE RESPUESTAS ---

Â  Â  Â  Â  function getBotResponse(userText) {
Â  Â  Â  Â  Â  Â  const lowerCaseText = userText.toLowerCase().trim();

Â  Â  Â  Â  Â  Â  if (waitingForFolio) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si estamos esperando el folio, cualquier texto es el folio/direcciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  if (lowerCaseText.length > 2) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  waitingForFolio = false; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return DETAILED_STATUS_MESSAGE; 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  for (const key in RESPUESTAS) {
Â  Â  Â  Â  Â  Â  Â  Â  const item = RESPUESTAS[key];
Â  Â  Â  Â  Â  Â  Â  Â  for (const variant of item.variantes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lowerCaseText.includes(variant.toLowerCase())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si es la respuesta para iniciar seguimiento, activamos la bandera
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key === "estado de reporte") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  waitingForFolio = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return item.respuesta;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return DEFAULT_RESPONSE;
Â  Â  Â  Â  }

Â  Â  Â  Â  function processUserMessage(userText) {
Â  Â  Â  Â  Â  Â  const botResponse = getBotResponse(userText);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Si la respuesta es la de seguimiento, la enviamos con un ligero retraso
Â  Â  Â  Â  Â  Â  if (botResponse.startsWith("INICIAR SEGUIMIENTO:")) {
Â  Â  Â  Â  Â  Â  Â  Â  const displayResponse = botResponse.substring("INICIAR SEGUIMIENTO:".length).trim();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(displayResponse, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  }, 800);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(botResponse, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  }, 800);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // =========================================================================================
Â  Â  Â  Â  // ğŸš¨ CÃ“DIGO MODIFICADO: FUNCIÃ“N REAL DE ENVÃO DE REPORTE A API (PARA GUARDAR EN GITHUB)
Â  Â  Â  Â  // =========================================================================================

Â  Â  Â  Â  // NOTA: La variable API_URL debe ser reemplazada con la URL de tu funciÃ³n Serverless (Vercel, Netlify, etc.)
Â  Â  Â  Â  const API_URL = 'https://lavozdelaluz-lumibot.vercel.app/api/report';

Â  Â  Â  Â  function sendReportToBackend(reportData) {
Â  Â  Â  Â  Â  Â  console.log("Enviando reporte real al servidor:", reportData);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 1. Mostrar un mensaje de espera (Opcional, pero recomendado)
Â  Â  Â  Â  Â  Â  appendMessage(`âŒ› Procesando reporte... Por favor, espera un momento.`, 'bot');

Â  Â  Â  Â  Â  Â  fetch(API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(reportData)
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return response.json();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  // Si la API responde con Ã©xito
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reportSummary = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **âœ… REPORTE GENERADO CON Ã‰XITO**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Folio:** ${reportData.folio}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **DirecciÃ³n:** ${reportData.direccion}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  **Falla de la Luminaria:** ${reportData.descripcion_falla} Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Tu reporte ha sido registrado y estÃ¡ en manos de la oficina. Conserva el **Folio ${reportData.folio}** para dar seguimiento. Â¡Tiempo de atenciÃ³n: 24 a 72 horas hÃ¡biles!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  El archivo JSON se estÃ¡ guardando en tu repositorio.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enviamos el resumen final despuÃ©s del proceso
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(reportSummary, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si la API responde, pero con error (ej. error de GitHub)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(`âš ï¸ **Error al guardar reporte (Folio ${reportData.folio}):** No se pudo comunicar con el sistema de registro. Intenta mÃ¡s tarde.`, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  // Manejar errores de red o errores HTTP
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error de fetch o de la API:', error);
Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(`âŒ **Error de red o del servidor:** No se pudo enviar el reporte (Folio ${reportData.folio}). Por favor, llama al 072.`, 'bot');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // =========================================================================================
Â  Â  Â  Â  // âš ï¸ FIN DE CÃ“DIGO MODIFICADO âš ï¸
Â  Â  Â  Â  // =========================================================================================


Â  Â  Â  Â  // --- LÃ“GICA DE ENVÃO Y REPORTE (Sin cambios, usa la nueva funciÃ³n sendReportToBackend) ---

Â  Â  Â  Â  function sendMessage() {
Â  Â  Â  Â  Â  Â  const userText = userInput.value.trim();
Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  Â  let imageURL = null;

Â  Â  Â  Â  Â  Â  if (!userText && !file) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Si hay imagen, creamos la URL local para mostrar
Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  imageURL = URL.createObjectURL(file);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const messageToSend = userText || '[Imagen de Reporte Adjunta]';
Â  Â  Â  Â  Â  Â  appendMessage(messageToSend, 'user', imageURL);

Â  Â  Â  Â  Â  Â  if (userText || file) {
Â  Â  Â  Â  Â  Â  Â  Â  const textToProcess = userText || "quiero reportar una falla";

Â  Â  Â  Â  Â  Â  Â  Â  // LÃ“GICA DE REPORTE FINAL: Si currentReportLocation estÃ¡ listo para recibir el texto de direcciÃ³n/falla
Â  Â  Â  Â  Â  Â  Â  Â  if (currentReportLocation !== undefined && currentReportLocation !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const folio = getNextFolio();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const textoCompleto = userText.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let direccion = textoCompleto;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let descripcionFalla = "Falla sin describir o el texto no siguiÃ³ el formato: DirecciÃ³n, Falla.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica de separaciÃ³n de DirecciÃ³n y Falla (Usando la Coma)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const firstCommaIndex = textoCompleto.indexOf(',');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (firstCommaIndex !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  direccion = textoCompleto.substring(0, firstCommaIndex).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  descripcionFalla = textoCompleto.substring(firstCommaIndex + 1).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ValidaciÃ³n de datos GPS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const gpsString = currentReportLocation.latitude ? 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `${currentReportLocation.latitude.toFixed(6)}, ${currentReportLocation.longitude.toFixed(6)}` : 'No obtenida / Permiso rechazado';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Preparar los datos a enviar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reportData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  folio: folio,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fecha: new Date().toLocaleString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  direccion: direccion,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  descripcion_falla: descripcionFalla,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ubicacionGPS: gpsString,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagenURL: file ? `Adjunta (${file.name})` : 'No',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  estado: 'Reportado'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enviar los datos (AHORA USA LA FUNCIÃ“N REAL CON FETCH)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendReportToBackend(reportData); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reiniciar el estado del reporte despuÃ©s de generar el folio
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentReportLocation = undefined;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileInput.value = ''; // Limpiar el archivo

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LÃ³gica de respuesta normal (no es reporte en curso)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processUserMessage(textToProcess);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  userInput.value = '';
Â  Â  Â  Â  Â  Â  fileInput.value = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleKeyPress(e) {
Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  sendMessage();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- LÃ“GICA DE GEOLOCALIZACIÃ“N Y REPORTE RÃPIDO ---
Â  Â  Â  Â  
Â  Â  Â  Â  function requestLocation() {
Â  Â  Â  Â  Â  Â  currentReportLocation = null; 
Â  Â  Â  Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (position) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentReportLocation = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latitude: position.coords.latitude,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  longitude: position.coords.longitude
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Corregida la sintaxis del enlace de Google Maps
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mapLink = `https://maps.google.com/?q=${currentReportLocation.latitude},${currentReportLocation.longitude}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(`âœ… **UbicaciÃ³n GPS Obtenida:** Lat: ${currentReportLocation.latitude.toFixed(5)}, Long: ${currentReportLocation.longitude.toFixed(5)}.<br>([Ver en Mapa](${mapLink}))`, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // MENSAJE ACTUALIZADO PARA SOLICITAR EL FORMATO DE LA COMA
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(`Ahora, por favor, escribe la **direcciÃ³n exacta SEGUIDA DE UNA COMA y la falla** (ej: **Calle 5, la luminaria estÃ¡ apagada**).`, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage = 'No fue posible obtener tu ubicaciÃ³n GPS.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error.code === error.PERMISSION_DENIED) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage += '<br>Necesitas aceptar el permiso de ubicaciÃ³n.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage += `<br>Error: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(`âš ï¸ **Alerta:** ${errorMessage}<br>Por favor, proporciona la direcciÃ³n exacta y la descripciÃ³n de la falla manualmente, usando el formato **DirecciÃ³n, Falla** para continuar.`, 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Establecemos un valor para que sendMessage sepa que ya se intentÃ³ la ubicaciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentReportLocation = { latitude: null, longitude: null }; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  appendMessage("âš ï¸ **Error:** Tu navegador no soporta la geolocalizaciÃ³n. Por favor, proporciona la direcciÃ³n exacta y la descripciÃ³n de la falla manualmente, usando el formato **DirecciÃ³n, Falla**.", 'bot');
Â  Â  Â  Â  Â  Â  Â  Â  Â // Establecemos un valor para
Â  Â  Â  Â  Â  Â  Â  Â  currentReportLocation = { latitude: null, longitude: null };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function startQuickReport() {
Â  Â  Â  Â  Â  Â  Â // 1. Mostrar el mensaje de Reporte RÃ¡pido
Â  Â  Â  Â  Â  Â  Â const reportMessage = RESPUESTAS["reportar"].respuesta;
Â  Â  Â  Â  Â  Â  Â appendMessage(reportMessage, 'bot');
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // 2. Intentar obtener la ubicaciÃ³n (activa el flujo de reporte)
Â  Â  Â  Â  Â  Â  Â requestLocation();
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- LÃ“GICA DE INICIO ---
Â  Â  Â  Â  
Â  Â  Â  Â  function sendBotInitialMessage() {
Â  Â  Â  Â  Â  Â  const welcomeMessage = RESPUESTAS["hola"].respuesta + 
Â  Â  Â  Â  Â  Â  Â  Â  "<br><br>Â¿Te gustarÃ­a hacer un **Reporte RÃ¡pido**? Puedes usar el botÃ³n rojo ğŸ’¡ de arriba, o escribir **'Reportar'** o Â¿Tienes una pregunta sobre **Horarios** o **Seguimiento**?";
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  appendMessage(welcomeMessage, 'bot');
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function loadConversation() {
Â  Â  Â  Â  Â  Â  // Elimina la conversaciÃ³n anterior al cargar la pÃ¡gina (se puede comentar si se desea persistencia)
Â  Â  Â  Â  Â  Â  localStorage.removeItem(CHAT_STORAGE_KEY);
Â  Â  Â  Â  Â  Â  chatBody.innerHTML = ''; 
Â  Â  Â  Â  }

Â  Â  Â  Â  function initializeApp() {
Â  Â  Â  Â  Â  Â  loadConversation(); 
Â  Â  Â  Â  Â  Â  const splashDuration = 2000; // 2 segundos

Â  Â  Â  Â  Â  Â  // Ocultar pantalla de carga
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  splashScreen.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  chatContainer.style.opacity = '1';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  splashScreen.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendBotInitialMessage();
Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  }, splashDuration);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Iniciar la aplicaciÃ³n al cargar la ventana
Â  Â  Â  Â  window.onload = initializeApp;

Â  Â  </script>
</body>
</html>


