<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi-Bot | Alumbrado P√∫blico</title>
    
    <link rel="icon" type="image/png" href="Aguascalientes.png"> 
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- ESTILOS CSS (SIN CAMBIOS) --- */
        
        body {
            font-family: Arial, sans-serif;
            background-image: url('Fondo animado.avif'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
        }

        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #128c7e; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            animation: bounce 1s infinite alternate;
        }
        
        #splash-screen h1 {
            color: white;
            font-size: 2em;
            margin-bottom: 5px;
        }

        #splash-screen p {
            color: #dcf8c6;
            font-size: 1em;
        }

        @keyframes bounce {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.05);
            }
        }
        
        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 80vh;
            max-height: 700px;
            background-color: #f7f7f7; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; 
            opacity: 0; 
            transition: opacity 0.5s ease-in;
        }

        .chat-header {
            background-color: #128c7e;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-avatar {
            background-color: #f0f0f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            overflow: hidden;
        }

        .header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-info h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .header-info p {
            margin: 0;
            font-size: 0.8em;
            opacity: 0.8;
        }

        .chat-body {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            background-image: url('Luminarias aguascalientes.jpeg'); 
            background-size: cover; 
            background-position: center; 
            background-color: rgba(229, 221, 213, 0.7); 
            background-blend-mode: color; 
            display: flex;
            flex-direction: column;
        }

        .message-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .bot-message {
            background-color: #ffffff; 
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .user-message {
            background-color: #dcf8c6; 
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .message-time {
            display: block;
            font-size: 0.65em;
            color: #777;
            text-align: right;
            margin-top: 5px;
            line-height: 1;
        }
        
        .message-image-container {
            max-width: 100%;
            margin-bottom: 5px;
            border-radius: 8px;
            overflow: hidden;
        }

        .message-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .chat-footer {
            padding: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            border: none;
            padding: 12px 15px;
            border-radius: 20px;
            font-size: 1em;
            margin: 0 8px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .chat-footer button {
            background-color: #128c7e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 4px;
            transition: background-color 0.3s;
        }

        .chat-footer button:hover {
            background-color: #0e6c60;
        }

        #attach-button {
            background-color: transparent;
            color: #777;
            width: 44px;
            height: 44px;
            margin-left: 4px;
        }
        
        #attach-button:hover {
            color: #555;
            background-color: transparent;
        }

        #attach-button .material-icons {
            transform: rotate(45deg); 
        }

        #report-button {
            position: absolute;
            top: 15px; 
            right: 15px; 
            background-color: #dc3545; 
            color: white;
            border: none;
            border-radius: 8px; 
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
            z-index: 10; 
        }

        #report-button:hover {
            background-color: #c82333; 
        }

        #report-button .material-icons {
            font-size: 24px; 
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="Logo alumbrado publico cute.jpg" alt="Logo Lumi-Bot">
        <h1>Lumi-Bot</h1>
        <p>Iniciando servicio de alumbrado...</p>
    </div>

    <div class="chat-container" id="chat-container">
        
        <button id="report-button" onclick="startQuickReport()">
            <span class="material-icons">lightbulb_outline</span> 
        </button>

        <div class="chat-header">
            <div class="header-avatar">
                <img src="Logo alumbrado publico cute.jpg" alt="Lumi-Bot Logo">
            </div>
            <div class="header-info">
                <h3>Lumi-Bot</h3>
                <p>Alumbrado P√∫blico | La voz de la luz</p>
            </div>
        </div>

        <div class="chat-body" id="chat-body">
        </div>

        <div class="chat-footer">
            <button id="attach-button" onclick="document.getElementById('file-input').click();">
                <span class="material-icons">attach_file</span>
            </button>

            <input type="file" id="file-input" accept="image/*" style="display: none;">

            <input type="text" id="user-input" placeholder="Escribe..." onkeypress="handleKeyPress(event)">

            <button onclick="sendMessage()">
                <span class="material-icons">send</span>
            </button>
        </div>
    </div>

    <script>
        // --- L√ìGICA JAVASCRIPT ---
        const chatContainer = document.getElementById('chat-container');
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const splashScreen = document.getElementById('splash-screen');
        const CHAT_STORAGE_KEY = 'lumi-bot-conversation';
        
        const DEFAULT_RESPONSE = "Lo siento, esa pregunta es nueva para m√≠. Intenta con **'hola'**, **'reportar'** o **'horario'** para guiarte.";

        let currentReportLocation = null;
        let waitingForFolio = false; 
        
        // ESTADOS ACTUALIZADOS: 'none', 'name', 'phone', 'address'
        let waitingFor = 'none'; 
        let reportDataBuffer = {}; // Buffer temporal para datos del reporte

        const DETAILED_STATUS_MESSAGE = "Estamos d√°ndole seguimiento a todas las solicitudes. Actualmente, tu reporte se encuentra en estado de **Verificaci√≥n en Campo** o **Reparaci√≥n Activa**.\n\nRecuerda que si ves una 'X' con cinta negra en la base, significa que fue **diagnosticada** y est√° en la lista de reparaciones prioritarias. ¬°El tiempo de atenci√≥n es de 24 a 72 horas h√°biles!";

        const RESPUESTAS = {
    // --- RESPUESTAS ORIGINALES ---
    "hola": {
        "variantes": ["hola", "holaaaa", "olis", "oli", "ola", "wenas", "buenos d√≠as", "buenas tardes"],
        "respuesta": "¬°Hola! Soy **Lumi-Bot**, tu asistente para Alumbrado P√∫blico. ¬øEn qu√© puedo ayudarte hoy?"
    },
    "qui√©n eres": {
        "variantes": ["qui√©n eres", "quien eres", "qu√© eres", "que eres"],
        "respuesta": "Soy un Chat-Bot dise√±ado para darte informaci√≥n y ayudarte a gestionar reportes del √°rea de Alumbrado P√∫blico. **¬°Mi misi√≥n es que tu calle brille!**"
    },
    "qu√© haces": {
        "variantes": ["qu√© haces", "que haces", "a qu√© te dedicas"],
        "respuesta": "Puedo responder dudas sobre reportes, servicios y horarios. Si quieres reportar una falla puedes escribir **'Reportar'** o si quieres saber del estado de tu reporte escribe **'Seguimiento'**."
    },
    "reportar": {
        "variantes": ["c√≥mo reporto una falla", "como reporto una falla", "quiero reportar una falla", "reportar", "reporte rapido"],
        "respuesta": "¬°Entendido! Vamos a generar un **Reporte R√°pido**. Primero, necesito tu ubicaci√≥n. El sistema ha solicitado permiso para usar tu GPS. Por favor, **acepta la solicitud de ubicaci√≥n** que aparece en tu navegador.\n\nSi ya lo hiciste, por favor, env√≠a un mensaje con la **Direcci√≥n exacta Y LA DESCRIPCI√ìN DE LA FALLA SEPARADA POR UNA COMA** (ej: calle X, luminaria parpadea). Puedes adjuntar una **foto** (opcional)."
    },
    "horario": {
        "variantes": ["cu√°l es tu horario", "cual es tu horario", "horario de atenci√≥n", "horario", "cual es el horario de alumbrado publico", "cual es el horario"],
        "respuesta": "El horario de atenci√≥n de Alumbardo Publico es de **Lunes a Domingo** y circulamos las **24 horas**."
    },
    "estado de reporte": {
        "variantes": ["reportes", "quiero saber de mi reporte", "seguimiento", "estado de mi reporte"],
        "respuesta": "INICIAR SEGUIMIENTO: <br>Perfecto, voy a buscar tu reporte. Por favor, ind√≠came tu **n√∫mero de folio** o la **direcci√≥n exacta** que reportaste."
    },
    "gracias": { "variantes": ["gracias", "muchas gracias"], "respuesta": "¬°De nada! Es un placer iluminar tu camino. " },
    "numero": { "variantes": ["numero", "cual es el numero"], "respuesta": "El n√∫mero oficial para reportes es el **072**. ¬°Gu√°rdalo! O si tienes problemas puedes llamar tambi√©n a este n√∫mero **449 910 1019**." },
    "link": {
        "variantes": ["link", "enlace", "formulario", "pagina web", "reporte detallado"],
        "respuesta": "Si quieres hacer un reporte m√°s detallado entra al siguiente enlace: \n** https://jonemoto24.github.io/Alumbrado-publico-de-Aguascalientes/ **\nEste link te facilitar√° m√°s la gesti√≥n de reportes."
    },
    "lamparas nuevas": {
        "variantes": ["lamparas nuevas", "nuevas lamparas", "instalacion", "cambio de luz"],
        "respuesta": "Constantemente estamos actualizando la infraestructura. Para solicitar la **instalaci√≥n de nuevas luminarias** o un **cambio de tecnolog√≠a**, es necesario comunicarte al **072** para evaluar la viabilidad del proyecto en tu zona."
    },
    "significado de alumbrado publico": {
        "variantes": ["significado de alumbrado publico", "que es alumbrado publico", "que significa alumbrado", "definicion"],
        "respuesta": "El **Alumbrado P√∫blico** es el servicio que busca iluminar las v√≠as de circulaci√≥n y los espacios p√∫blicos. Su prop√≥sito es proporcionar **seguridad**, **visibilidad** y **mejorar la calidad de vida** de los ciudadanos durante la noche."
    },
    "lampara caida": {
        "variantes": ["lampara caida", "poste caido", "luminaria tirada", "columna rota", "peligro"],
        "respuesta": "üö® **¬°ATENCI√ìN, PELIGRO!** Si una l√°mpara, poste o luminaria est√° ca√≠da, representa un riesgo el√©ctrico y f√≠sico. Por favor, llama inmediatamente al n√∫mero de **Emergencias (911)** y notifica tambi√©n al **072** para que sea atendida con m√°xima prioridad."
    },
    "fotoceldas": {
        "variantes": ["fotoceldas", "foto celda", "porque se prende de dia", "se prende de dia"],
        "respuesta": "Las luminarias son controladas por **fotoceldas**, que son sensores de luz. Si una l√°mpara enciende de d√≠a, la fotocelda probablemente est√° fallando. Este es un reporte com√∫n; por favor, usa **'Reportar'** para indicarnos la direcci√≥n y corregir el problema."
    },
    "colores de las lamparas": {
        "variantes": ["colores de las lamparas", "luz amarilla", "luz blanca", "tipo de lampara"],
        "respuesta": "En Aguascalientes usamos principalmente tecnolog√≠a **LED (luz blanca/fr√≠a)** por su eficiencia energ√©tica. Anteriormente se usaba **Vapor de Sodio (luz amarilla)**. Si detectas un cambio de color abrupto o intermitente, podr√≠a ser se√±al de una falla que requiere reparaci√≥n."
    },
    
    "trabajan en d√≠as festivos": {
        "variantes": ["trabajan en d√≠as festivos", "trabajan d√≠as festivos", "¬øhay servicio en d√≠as festivos?"],
        "respuesta": "S√≠, el personal de **Alumbrado P√∫blico opera las 24 horas del d√≠a, los 7 d√≠as de la semana**, incluyendo d√≠as festivos y fines de semana, especialmente para atender fallas cr√≠ticas o reportes de peligro."
    },
    "quitar tenis colgados": {
        "variantes": ["quitar tenis colgados de las l√°mparas", "quiten los zapatos colgados", "tenis colgados de los cables", "quitar tenis colgados de los postes"],
        "respuesta": "El retiro de objetos colgados en el cableado o las luminarias (como tenis o zapatos) es una labor que debe realizarse con equipo especializado. Por favor, reporta la ubicaci√≥n exacta al **072** para que el personal de mantenimiento programe su retiro."
    },
    "ir directamente a oficinas": {
        "variantes": ["puedo ir directamente a las oficinas a reclamar", "ir a la oficina a quejarme", "direcci√≥n de oficinas de alumbrado"],
        "respuesta": "S√≠, puedes acudir a las oficinas de atenci√≥n ciudadana para levantar un reporte o dar seguimiento. Sin embargo, te recomendamos usar el **tel√©fono 072** o el **chatbot** para un tr√°mite m√°s r√°pido y directo."
    },
    "qui√©n fund√≥ el alumbrado p√∫blico": {
        "variantes": ["qui√©n fund√≥ el alumbrado p√∫blico", "quien invent√≥ el alumbrado", "historia del alumbrado"],
        "respuesta": "El concepto de alumbrado p√∫blico evolucion√≥ con la historia. El **alumbrado moderno y el√©ctrico** (con bombillas incandescentes o LED) no tiene un √∫nico fundador, sino que se atribuye a la implementaci√≥n de tecnolog√≠a de figuras como **Thomas Edison** y sistemas municipales en las grandes ciudades a finales del siglo XIX."
    },
    "por qu√© nunca vienen a villas": {
        "variantes": ["por qu√© los de alumbrado nunca vienen a villas", "no atienden mi colonia", "tardan mucho en mi zona"],
        "respuesta": "El servicio de Alumbrado P√∫blico cubre todas las zonas del municipio. La asignaci√≥n de cuadrillas se basa en la **prioridad y la concentraci√≥n de reportes**. Si sientes que hay un retraso en tu zona, llama al **072** o env√≠a tu reporte detallado para asegurar que tu solicitud est√© bien registrada."
    },
    "venir hoy mismo a arreglar": {
        "variantes": ["pueden venir hoy mismo a arreglar la l√°mpara", "arreglo inmediato"],
        "respuesta": "Los reportes se atienden en un lapso de **24 a 72 horas h√°biles**. Las fallas que involucran peligro (poste ca√≠do, corto circuito) se atienden con **m√°xima prioridad** y de forma inmediata si es posible, pero las fallas comunes siguen la programaci√≥n regular."
    },
    "l√°mpara se cae ustedes la pueden arreglar": {
        "variantes": ["si la l√°mpara se cae, ustedes mismos la pueden arreglar", "poste chocado", "reparar columna"],
        "respuesta": "S√≠, la cuadrilla de Alumbrado P√∫blico est√° capacitada para atender y reparar la ca√≠da de luminarias y postes. Recuerda que, si hay peligro inminente (cables sueltos), debes llamar primero al **911**."
    },
    "me puedo robar la l√°mpara": {
        "variantes": ["me puedo robar la l√°mpara", "robar faro", "robo de luminaria"],
        "respuesta": "‚ùå **¬°ADVERTENCIA!** El robo, da√±o o manipulaci√≥n de la infraestructura de alumbrado p√∫blico es un **delito federal** que conlleva severas multas y penas de prisi√≥n. La luminaria pertenece al municipio."
    },
    "qu√© pasa si me rob√≥ la l√°mpara ca√≠da": {
        "variantes": ["qu√© pasa si me rob√≥ la l√°mpara ca√≠da", "robar poste tirado"],
        "respuesta": "A√∫n si la l√°mpara est√° ca√≠da, sigue siendo propiedad municipal y contiene componentes el√©ctricos valiosos. Robarla o llev√°rtela es un **delito de robo de infraestructura p√∫blica** y puede implicar riesgo de electrocuci√≥n. Por favor, **rep√≥rtala al 911/072** para que sea retirada de forma segura."
    },
    "vinculados al CFE": {
        "variantes": ["est√°n vinculados al CFE", "trabajan con CFE"],
        "respuesta": "El servicio de Alumbrado P√∫blico es administrado por el **Gobierno Municipal**. Aunque CFE es nuestro proveedor de energ√≠a y trabajamos en coordinaci√≥n en ciertas √°reas de infraestructura el√©ctrica, la **responsabilidad del mantenimiento y la reparaci√≥n de las luminarias es totalmente municipal**."
    },
    "diferencias alumbrado y CFE": {
        "variantes": ["en qu√© se diferencian el alumbrado p√∫blico y el CFE", "diferencia CFE y alumbrado"],
        "respuesta": "**CFE** es la empresa federal encargada de generar, distribuir y comercializar la **energ√≠a el√©ctrica** a los hogares y negocios. El **Alumbrado P√∫blico (Municipal)** es la dependencia que se encarga exclusivamente del **mantenimiento, reparaci√≥n y expansi√≥n de las luminarias** en calles, parques y espacios p√∫blicos."
    },
    "poner luces a mi pino": {
        "variantes": ["pueden venir a ponerle las luces a mi pino", "decoraci√≥n de navidad"],
        "respuesta": "No, el servicio de Alumbrado P√∫blico se enfoca exclusivamente en la infraestructura de seguridad y vialidad. No podemos ayudarte con la **instalaci√≥n de luces decorativas** o privadas en tu domicilio o pino navide√±o."
    },
    "por qu√© rompieron la calle": {
        "variantes": ["por qu√© rompieron la calle si ven√≠an a arreglar la l√°mpara", "abrieron pavimento"],
        "respuesta": "En ocasiones, la falla de una luminaria est√° en el **cableado subterr√°neo** o en la base del poste. Es necesario abrir una peque√±a zanja en el pavimento para acceder y realizar la reparaci√≥n, asegurando que la conexi√≥n sea duradera. El √°rea debe ser reparada por la misma cuadrilla de obra al finalizar el trabajo."
    },
    "por qu√© hacen un tiradero": {
        "variantes": ["por qu√© hacen un tiradero cuando ni siquiera trabajan", "dejan basura", "no recogen escombros"],
        "respuesta": "Nuestro protocolo exige que se deje el √°rea de trabajo limpia y segura. Si una cuadrilla dej√≥ escombros o materiales, por favor, **reporta la ubicaci√≥n al 072** para que se env√≠e una cuadrilla de limpieza inmediatamente."
    },
    "por qu√© hay tanto cable en los postes": {
        "variantes": ["por qu√© hay tanto cable en los postes", "exceso de cables"],
        "respuesta": "Los postes son compartidos por m√∫ltiples servicios (luz el√©ctrica, telefon√≠a, internet, televisi√≥n por cable). El **Alumbrado P√∫blico** usa solo un peque√±o porcentaje de esos cables. La regulaci√≥n del resto de la infraestructura corresponde a otras dependencias o empresas privadas."
    },
    "quien dirige el alumbrado p√∫blico": {
        "variantes": ["quien dirige el alumbrado p√∫blico", "director de alumbrado"],
        "respuesta": "El √°rea de Alumbrado P√∫blico est√° bajo la direcci√≥n de la **Secretar√≠a de Servicios P√∫blicos Municipales** de Aguascalientes."
    },
    "n√∫mero para hablar con humano": {
        "variantes": ["hay alg√∫n n√∫mero de tel√©fono para marcar directamente a alguien humano", "tel√©fono humano"],
        "respuesta": "S√≠, el n√∫mero oficial **072** est√° operado por personal humano y funciona las 24 horas del d√≠a para canalizar tus reportes o dudas de forma verbal. Tambi√©n puedes marcar al **449 910 1019**."
    },
    "pago para la luz": {
        "variantes": ["aqu√≠ puedo hacer el pago para la luz", "pago recibo luz", "pagar electricidad"],
        "respuesta": "No, el **Lumi-Bot** no gestiona pagos. El pago del servicio de luz de tu casa debe realizarse directamente ante la **CFE**."
    },
    "pasar la luz de la l√°mpara a mi casa": {
        "variantes": ["me pueden pasar la luz de la l√°mpara a mi casa", "tomar luz de poste", "robar luz de calle"],
        "respuesta": "‚ùå **¬°TERMINANTEMENTE PROHIBIDO!** Conectarse ilegalmente a la red de alumbrado p√∫blico (el 'diablito') es un **delito de alto riesgo** que pone en peligro a tu familia y causa serios da√±os al sistema el√©ctrico municipal. **Por favor, no lo hagas**."
    },
    "volver a poner la luz de mi casa": {
        "variantes": ["me pueden volver a poner la luz de mi casa", "me la cortaron la luz", "reconexi√≥n de luz"],
        "respuesta": "Esa solicitud debe hacerse directamente a la **CFE** (Comisi√≥n Federal de Electricidad). Ellos son los √∫nicos responsables de reconectar, cortar o modificar el servicio el√©ctrico en domicilios particulares. Llama a su l√≠nea de atenci√≥n al cliente."
    }
};
        // --- FUNCIONES DE UTILIDAD ---
        
        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function saveConversation() {
            // Guarda la conversaci√≥n (actualmente desactivado)
        }
        
        function appendMessage(text, sender, imageURL = null) {
            const time = getCurrentTime();
            const messageDiv = document.createElement('div');
            // Reemplaza \n (saltos de l√≠nea) por <br> y da formato a negritas
            const formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            messageDiv.classList.add('message-bubble', sender === 'bot' ? 'bot-message' : 'user-message');

            let contentHTML = '';

            if (imageURL) {
                contentHTML += `
                    <div class="message-image-container">
                        <img src="${imageURL}" alt="Imagen adjunta" class="message-image">
                    </div>
                `;
            }

            contentHTML += `<span>${formattedText}</span>`;
            contentHTML += `<span class="message-time">${time}</span>`;

            messageDiv.innerHTML = contentHTML;
            chatBody.appendChild(messageDiv);

            chatBody.scrollTop = chatBody.scrollHeight;
            saveConversation();
        }

        function getBotResponse(userText) {
            const lowerCaseText = userText.toLowerCase().trim();

            if (waitingForFolio) {
                if (lowerCaseText.length > 2) { 
                    waitingForFolio = false; 
                    return DETAILED_STATUS_MESSAGE; 
                }
            }
            
            for (const key in RESPUESTAS) {
                const item = RESPUESTAS[key];
                for (const variant of item.variantes) {
                    if (lowerCaseText.includes(variant.toLowerCase())) {
                        if (key === "estado de reporte") {
                            waitingForFolio = true;
                        }
                        return item.respuesta;
                    }
                }
            }
            return DEFAULT_RESPONSE;
        }

        function processUserMessage(userText) {
            const botResponse = getBotResponse(userText);
            
            if (botResponse.startsWith("INICIAR SEGUIMIENTO:")) {
                const displayResponse = botResponse.substring("INICIAR SEGUIMIENTO:".length).trim();
                setTimeout(() => {
                    appendMessage(displayResponse, 'bot');
                }, 800);
            } else {
                setTimeout(() => {
                    appendMessage(botResponse, 'bot');
                }, 800);
            }
        }
        
        // =========================================================================================
        // üíæ FUNCI√ìN DE ENV√çO DE REPORTE A API DE VERCEL
        // =========================================================================================

        const API_URL = 'https://lavozdelaluz-lumibot.vercel.app/api/report'; 
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.readAsDataURL(file); // Lee el archivo como base64
                reader.onload = () => resolve({
                    base64: reader.result, // Data URL (incluye prefijo: data:image/png;base64,...)
                    fileType: file.type
                });
                reader.onerror = error => reject(error);
            });
        }

        async function sendReportToBackend(reportData, imageData) {
            console.log("Enviando reporte al servidor para asignaci√≥n de folio √∫nico y subida de imagen...");
            
            appendMessage(`‚åõ Procesando reporte... Guardando datos y asignando **Folio √önico** en el sistema central.`, 'bot');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reportData: reportData, 
                        imageData: imageData   
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success && data.folio) { 
                    
                    let reportSummary = `
                        **‚úÖ REPORTE GENERADO CON √âXITO**
                        
                        **Folio:** ${data.folio}
                        **Nombre de quien reporta:** ${reportData.nombre}
                        **N√∫mero de contacto:** ${reportData.numero}
                        **Direcci√≥n:** ${reportData.direccion}
                        **Falla:** ${reportData.descripcion_falla} ¬† ¬† ¬† ¬†
                    `;
                    
                    if (data.imageUrl && data.imageUrl !== 'No') {
                         reportSummary += `\n\n**Foto de Reporte:** [Ver Imagen Adjunta](${data.imageUrl})`;
                    } else if (data.imageUrl.startsWith("Fallo")) {
                         reportSummary += `\n\n‚ö†Ô∏è **Alerta:** La foto no se pudo guardar. ${data.imageUrl}`;
                    } else {
                         reportSummary += `\n\n**Foto de Reporte:** No`;
                    }
                    
                    reportSummary += `\n\nTu reporte ha sido registrado. Conserva el **Folio ${data.folio}** para dar seguimiento.`;

                    appendMessage(reportSummary, 'bot');
                } else {
                    appendMessage(`‚ö†Ô∏è **Fallo en el Sistema de Registro:** El servidor no pudo asignar el folio. Intenta m√°s tarde o llama al 072.`, 'bot');
                }
            } catch (error) {
                console.error('Error de fetch o de la API:', error);
                appendMessage(`‚ùå **Error de red o del servidor:** No se pudo contactar al sistema central. Llama al 072.`, 'bot');
            }
        }

        // --- L√ìGICA DE ENV√çO Y REPORTE GUIADO ---

        async function sendMessage() {
            const userText = userInput.value.trim();
            const file = fileInput.files[0];
            let imageURL_Local = null; 
            
            if (!userText && !file && waitingFor === 'none') {
                return;
            }
            
            if (file) {
                imageURL_Local = URL.createObjectURL(file);
                const imageData_Server = await readFileAsBase64(file);
                reportDataBuffer.imageData = imageData_Server; // Guarda la imagen en el buffer
            }

            const messageToSend = userText || '[Imagen de Reporte Adjunta]';
            // Solo muestra el mensaje del usuario si hay texto o se est√° en modo conversaci√≥n normal
            if (waitingFor === 'none' || userText) {
                appendMessage(messageToSend, 'user', imageURL_Local);
            }
            
            userInput.value = '';
            fileInput.value = '';
            
            // --- FLUJO DE REPORTE GUIADO (3 PASOS) ---

            if (waitingFor === 'name') {
                // PASO 1: Recibir el nombre
                reportDataBuffer.nombre = userText || 'An√≥nimo';
                waitingFor = 'phone'; 
                
                appendMessage(`¬°Gracias, **${reportDataBuffer.nombre}**!`, 'bot');
                appendMessage("Ahora, por favor, ingresa tu **n√∫mero de tel√©fono** de contacto (ej: 4491234567).", 'bot');
                return;
            }

            if (waitingFor === 'phone') {
                // PASO 2: Recibir el tel√©fono
                reportDataBuffer.numero = userText || 'No proporcionado';
                waitingFor = 'address'; // Pasa al siguiente estado: Direcci√≥n
                
                requestLocation(); // Llama a la funci√≥n que pide la ubicaci√≥n GPS y la direcci√≥n/falla
                return;
            }


            if (waitingFor === 'address') {
                // PASO 3: Recibir la direcci√≥n y descripci√≥n de la falla y ENVIAR EL REPORTE
                
                if (!currentReportLocation || !userText) {
                    appendMessage("‚ö†Ô∏è Por favor, ingresa la **Direcci√≥n exacta Y la DESCRIPCI√ìN DE LA FALLA** separadas por una coma. (ej: Calle 5, la luminaria parpadea).", 'bot');
                    return;
                }

                const textoCompleto = userText.trim();
                let direccion = textoCompleto;
                let descripcionFalla = "Falla sin describir o el texto no sigui√≥ el formato: Direcci√≥n, Falla.";
                
                const firstCommaIndex = textoCompleto.indexOf(',');

                if (firstCommaIndex !== -1) {
                    direccion = textoCompleto.substring(0, firstCommaIndex).trim();
                    descripcionFalla = textoCompleto.substring(firstCommaIndex + 1).trim();
                } 
                
                // Preparar los datos finales del reporte
                const gpsString = currentReportLocation.latitude ? 
                    `${currentReportLocation.latitude.toFixed(6)}, ${currentReportLocation.longitude.toFixed(6)}` : 'No obtenida / Permiso rechazado';

                const reportData = {
                    nombre: reportDataBuffer.nombre,
                    numero: reportDataBuffer.numero, // Nuevo campo
                    fecha: new Date().toLocaleString(),
                    direccion: direccion,
                    descripcion_falla: descripcionFalla,
                    ubicacionGPS: gpsString,
                    imagenURL: reportDataBuffer.imageData ? 'Pendiente' : 'No', 
                    estado: 'Reportado'
                };

                // ENV√çO FINAL
                sendReportToBackend(reportData, reportDataBuffer.imageData); 

                // Resetear estados
                waitingFor = 'none';
                currentReportLocation = undefined;
                reportDataBuffer = {}; 
                
                return;
            }
            
            // --- L√ìGICA DE CONVERSACI√ìN NORMAL (Si waitingFor === 'none') ---
            
            if (userText) {
                processUserMessage(userText);
            } else if (file) {
                appendMessage("Solo recib√≠ una imagen. Para reportar una falla, escribe **'Reportar'** o usa el bot√≥n rojo üí°.", 'bot');
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }
        
        // --- L√ìGICA DE GEOLOCALIZACI√ìN Y REPORTE R√ÅPIDO ---
        
        function requestLocation() {
            currentReportLocation = null; 
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentReportLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        
                        const mapLink = `https://www.google.com/maps/search/?api=1&query=${currentReportLocation.latitude},${currentReportLocation.longitude}`;
                        
                        appendMessage(`‚úÖ **Ubicaci√≥n GPS Obtenida:** Lat: ${currentReportLocation.latitude.toFixed(5)}, Long: ${currentReportLocation.longitude.toFixed(5)}.<br>([Ver en Mapa](${mapLink}))`, 'bot');
                        
                        appendMessage(`Casi terminamos. Ahora, escribe la **direcci√≥n exacta SEGUIDA DE UNA COMA y la falla** (ej: **Calle 5, la luminaria est√° apagada**).`, 'bot');
                        
                    },
                    (error) => {
                        let errorMessage = 'No fue posible obtener tu ubicaci√≥n GPS.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += '<br>Necesitas aceptar el permiso de ubicaci√≥n.';
                        } else {
                            errorMessage += `<br>Error: ${error.message}`;
                        }
                        appendMessage(`‚ö†Ô∏è **Alerta:** ${errorMessage}<br>Por favor, proporciona la direcci√≥n exacta y la descripci√≥n de la falla manualmente, usando el formato **Direcci√≥n, Falla** para continuar.`, 'bot');
                        currentReportLocation = { latitude: null, longitude: null }; 
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                appendMessage("‚ö†Ô∏è **Error:** Tu navegador no soporta la geolocalizaci√≥n. Por favor, proporciona la direcci√≥n exacta y la descripci√≥n de la falla manualmente, usando el formato **Direcci√≥n, Falla**.", 'bot');
                currentReportLocation = { latitude: null, longitude: null };
            }
        }

        function startQuickReport() {
             waitingFor = 'name'; // INICIA el proceso pidiendo el nombre
             reportDataBuffer = {}; // Limpia el buffer
             appendMessage("¬°Entendido! Vamos a generar tu **Reporte R√°pido**.<br>Primero, ¬øCu√°l es tu **nombre completo**? (Opcional, si prefieres mantener tu anonimato, solo escribe 'An√≥nimo').", 'bot');
        }

        function sendBotInitialMessage() {
            const welcomeMessage = RESPUESTAS["hola"].respuesta + 
                "<br><br>¬øTe gustar√≠a hacer un **Reporte R√°pido**? Puedes usar el bot√≥n rojo üí° de arriba, o escribir **'Reportar'** o ¬øTienes una pregunta sobre **Horarios** o **Seguimiento**?";
            appendMessage(welcomeMessage, 'bot');
        }
        
        function loadConversation() {
            localStorage.removeItem(CHAT_STORAGE_KEY);
            chatBody.innerHTML = ''; 
        }

        function initializeApp() {
            loadConversation(); 
            const splashDuration = 2000; 

            setTimeout(() => {
                splashScreen.style.opacity = '0';
                chatContainer.style.opacity = '1';
                
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    sendBotInitialMessage();
                }, 500);
                
            }, splashDuration);
        }
        
        window.onload = initializeApp;

    </script>
</body>
</html>




